<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Chatbot - WebSocket</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 0; background: #0b1020; color: #e6e8f0; }
    .container { max-width: 860px; margin: 0 auto; padding: 16px; }
    .card { background: #11162a; border: 1px solid #1f2746; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.35); }
    header { padding: 16px 20px; border-bottom: 1px solid #1f2746; display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 16px; margin: 0; font-weight: 600; letter-spacing: 0.3px; }
    header .status { margin-left: auto; font-size: 12px; opacity: 0.8; }
    #messages { height: 60vh; overflow-y: auto; padding: 16px 20px; display: flex; flex-direction: column; gap: 12px; }
    .msg { padding: 12px 14px; border-radius: 10px; white-space: pre-wrap; line-height: 1.5; font-size: 14px; }
    .user { background: #1a2140; border: 1px solid #2a3563; align-self: flex-end; }
    .bot { background: #0d1328; border: 1px solid #232d53; align-self: flex-start; }
    .controls { border-top: 1px solid #1f2746; padding: 12px; display: grid; grid-template-columns: 1fr auto; gap: 8px; }
    #input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid #2a3563; background: #0b1020; color: #e6e8f0; outline: none; }
    #send { padding: 12px 16px; border-radius: 10px; border: 1px solid #2a3563; background: #1a2140; color: #e6e8f0; cursor: pointer; }
    #send:disabled { opacity: 0.6; cursor: not-allowed; }
    .row { display: flex; gap: 8px; align-items: center; padding: 12px; border-top: 1px solid #1f2746; }
    .row input { flex: 1; padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3563; background: #0b1020; color: #e6e8f0; outline: none; }
    .row button { padding: 10px 12px; border-radius: 8px; border: 1px solid #2a3563; background: #1a2140; color: #e6e8f0; cursor: pointer; }
    .hint { font-size: 12px; opacity: 0.7; padding: 0 12px 12px; }
  </style>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>
  <div class="container">
    <div class="card">
      <header>
        <h1>AI Chatbot (WebSocket)</h1>
        <div class="status" id="status">Disconnected</div>
      </header>

      <div class="row">
        <input id="wsUrl" value="ws://localhost:8000/ws/chat" />
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" disabled>Disconnect</button>
      </div>
      <div class="hint">Update the URL if your backend runs elsewhere.</div>

      <div id="messages"></div>

      <div class="controls">
        <input id="input" placeholder="Type your message..." />
        <button id="send" disabled>Send</button>
      </div>
      <div class="row">
        <input id="imageInput" type="file" accept="image/*" multiple />
        <button id="clearImages">Clear Images</button>
      </div>
      <div class="hint" id="imageHint">No images selected.</div>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const wsUrlEl = document.getElementById('wsUrl');
    const connectBtn = document.getElementById('connectBtn');
    const disconnectBtn = document.getElementById('disconnectBtn');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');
    const messagesEl = document.getElementById('messages');
    const imageInputEl = document.getElementById('imageInput');
    const clearImagesBtn = document.getElementById('clearImages');
    const imageHintEl = document.getElementById('imageHint');

    let socket = null;
    let pendingImages = [];

    function addMessage(text, role) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.textContent = text;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setConnected(connected) {
      statusEl.textContent = connected ? 'Connected' : 'Disconnected';
      connectBtn.disabled = connected;
      disconnectBtn.disabled = !connected;
      sendBtn.disabled = !connected;
      inputEl.disabled = !connected;
    }

    connectBtn.addEventListener('click', () => {
      const url = wsUrlEl.value.trim();
      if (!url) return;

      socket = new WebSocket(url);

      socket.addEventListener('open', () => {
        setConnected(true);
        addMessage('Connected to server', 'bot');
      });

      socket.addEventListener('message', (event) => {
        addMessage(event.data, 'bot');
      });

      socket.addEventListener('close', () => {
        setConnected(false);
        addMessage('Disconnected', 'bot');
      });

      socket.addEventListener('error', (err) => {
        console.error(err);
        addMessage('Error occurred. Check console.', 'bot');
      });
    });

    disconnectBtn.addEventListener('click', () => {
      if (socket && socket.readyState === WebSocket.OPEN) {
        socket.close();
      }
    });

    function sendMessage() {
      const text = inputEl.value.trim();
      if ((!text && pendingImages.length === 0) || !socket || socket.readyState !== WebSocket.OPEN) return;

      addMessage(text || '[Image message]', 'user');

      const payload = {
        text,
        images: pendingImages.map(img => ({ data: img.data, mime_type: img.mime }))
      };

      socket.send(JSON.stringify(payload));
      inputEl.value = '';
      pendingImages = [];
      updateImageHint();
      inputEl.focus();
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function updateImageHint() {
      if (pendingImages.length === 0) {
        imageHintEl.textContent = 'No images selected.';
      } else {
        imageHintEl.textContent = `${pendingImages.length} image(s) ready to send.`;
      }
    }

    async function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const result = reader.result;
          const base64 = String(result).split(',')[1];
          resolve({ data: base64, mime: file.type || 'image/jpeg' });
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    imageInputEl.addEventListener('change', async (e) => {
      const files = Array.from(e.target.files || []);
      const converted = await Promise.all(files.map(fileToBase64));
      pendingImages = converted;
      updateImageHint();
    });

    clearImagesBtn.addEventListener('click', () => {
      pendingImages = [];
      imageInputEl.value = '';
      updateImageHint();
    });

    updateImageHint();
  </script>
</body>
</html>


